<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DevilWin - Kheliye aur Jeetiye</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #1a0b2e; color: #f0f0f0; }
        
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: url('https://i.ibb.co/tqBv6dK/ludo-board-faint.png') center/contain no-repeat;
            opacity: 0.05;
            z-index: -1;
        }

        .ludo-bg-pattern { background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 15px 15px; }
        .glassmorphism { background: rgba(40, 25, 65, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bottom-nav-item.active { color: #facc15; }
        #qrcode-container img { background: white; padding: 10px; border-radius: 8px; margin: 0 auto; }
        .winner-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
            background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .winner-animation i { font-size: 100px; color: #facc15; animation: crown-pop 0.5s ease-out; }
        .winner-animation p { font-size: 2rem; font-weight: bold; color: white; animation: text-fade-in 1s ease-out; }
        @keyframes crown-pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes text-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        .history-item .status-pending { color: #facc15; }
        .history-item .status-approved, .history-item .status-completed { color: #4ade80; }
        .history-item .status-rejected { color: #f87171; }
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        .leaderboard-tab-btn.active-tab {
            color: #facc15;
            border-bottom: 2px solid #facc15;
            background-color: rgba(250, 204, 21, 0.1);
        }
        .leaderboard-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="ludo-bg-pattern">

    <div id="ludo-loader" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-80 hidden">
        <div class="text-center">
            <img src="https://media.tenor.com/J4o_t22H3wAAAAAi/ludo-ludo-king.gif" alt="Loading..." class="w-20 h-20 mx-auto" />
            <p class="text-white mt-2 text-center text-sm">Loading...</p>
        </div>
    </div>

    <div id="global-alert" class="hidden fixed top-5 left-1/2 -translate-x-1/2 glassmorphism p-3 rounded-full shadow-lg z-[100] border-l-4 max-w-sm w-full">
        <p id="global-alert-message" class="text-center text-sm font-medium text-white"></p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <header class="p-3 flex justify-between items-center bg-gray-900/50 backdrop-blur-md sticky top-0 z-20 border-b border-gray-700">
            <h1 class="text-2xl font-extrabold text-yellow-400 drop-shadow-lg">DevilWin</h1>
            <div class="flex items-center space-x-4">
                <button id="header-wallet-btn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold px-4 py-2 rounded-full shadow-lg flex items-center">
                    <i class="fas fa-wallet mr-2"></i><span id="header-wallet-balance">‚Çπ0.00</span>
                </button>
                <div class="relative">
                    <button id="header-profile-btn" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center overflow-hidden">
                         <i class="fas fa-user text-xl text-gray-300"></i>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-50">
                        <a href="#" id="profile-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Profile</a>
                        <a href="#" id="achievement-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Achievements</a>
                        <a href="#" id="support-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Support</a>
                        <a href="#" id="terms-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Terms & Conditions</a>
                        <a href="#" id="privacy-policy-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Privacy Policy</a>
                        <a href="#" id="skill-disclaimer-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Skill Disclaimer</a>
                        <a href="#" id="refund-policy-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Refund Policy</a>
                        <a href="#" id="fair-play-policy-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Fair Play Policy</a>
                        <a href="#" id="responsible-gaming-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Responsible Gaming</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="pb-20">
            <!-- Home Page -->
            <div id="home-page" class="page p-4 space-y-6">
                 <div class="bg-gradient-to-br from-red-600 to-purple-700 p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold">Ludo King Battles</h2>
                    <p class="text-purple-200 mb-4">Create or Join Rooms & Win Big!</p>
                    <button id="view-battles-btn" class="bg-white text-black font-bold px-8 py-3 rounded-full shadow-md hover:scale-105 transition-transform">View All Battles</button>
                </div>

                <!-- NEW REFER AND EARN SECTION -->
                <div id="refer-earn-section" class="glassmorphism p-4 rounded-2xl flex items-center justify-between gap-4 hover:border-yellow-400 transition-all cursor-pointer">
                    <div class="flex-shrink-0">
                        <i class="fas fa-gift text-yellow-400 text-4xl animate-pulse"></i>
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg text-white">Refer & Earn</h3>
                        <p class="text-xs text-gray-300">Share with friends & get amazing rewards!</p>
                    </div>
                    <button id="share-referral-btn" class="bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold px-5 py-2.5 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
                        <i class="fas fa-share-alt"></i>
                        <span>Share</span>
                    </button>
                </div>
                <!-- END OF NEW SECTION -->

                <!-- Leaderboard Section -->
                <div class="glassmorphism p-4 rounded-2xl">
                    <div class="flex justify-center border-b border-gray-700 mb-4">
                        <button id="daily-leaderboard-btn" class="leaderboard-tab-btn active-tab flex-1 py-2 px-4 font-bold text-yellow-400 border-b-2 border-yellow-400 transition-all">Daily</button>
                        <button id="weekly-leaderboard-btn" class="leaderboard-tab-btn flex-1 py-2 px-4 font-bold text-gray-500 transition-all">Weekly</button>
                    </div>

                    <!-- Daily Leaderboard Container -->
                    <div id="daily-leaderboard" class="leaderboard-content">
                        <h2 class="text-xl font-bold text-center text-yellow-400 mb-4">Aaj ke Champions</h2>
                        <div id="leaderboard-bots" class="flex justify-around mb-4"></div>
                        <div id="leaderboard-real" class="space-y-2">
                            <p class="text-center text-gray-400">Loading live rankings...</p>
                        </div>
                    </div>

                    <!-- Weekly Leaderboard Container -->
                    <div id="weekly-leaderboard" class="leaderboard-content hidden">
                         <h2 class="text-xl font-bold text-center text-green-400 mb-4">Hafte ke Sikandar</h2>
                         <div id="leaderboard-weekly-real" class="space-y-2">
                            <p class="text-center text-gray-400">Loading weekly rankings...</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Battles Page -->
            <div id="battles-page" class="page p-4 space-y-6">
                 <div class="flex justify-end">
                    <button id="create-battle-btn" class="bg-gradient-to-r from-red-500 to-yellow-500 text-white font-bold px-6 py-2 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed">Create Battle</button>
                </div>
                <!-- Live Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-satellite-dish text-red-500 mr-2 animate-pulse"></i>My Battles</h2>
                    <div id="live-battles-list" class="space-y-3">
                        <p class="text-center text-gray-500">You are not in any battle right now.</p>
                    </div>
                </div>
                <!-- Active Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2">Open Battles</h2>
                    <div id="active-battles-list" class="space-y-3">
                        <p class="text-center text-gray-500">No open battles. Create one!</p>
                    </div>
                </div>
            </div>
            <!-- Achievement Page (Tailwind UI) -->
            <div id="achievement-page" class="page p-4">
              <div class="bg-gray-800 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-6">üèÜ Achievement Rewards</h2>

                <!-- User Streak Progress -->
                <div class="mb-6">
                  <p class="text-center text-gray-300 mb-2">Daily Battle Progress</p>
                  <div class="grid grid-cols-7 gap-2">
                    <!-- Day blocks: Replace with dynamic class based on progress -->
                    <div class="p-3 rounded-lg text-center bg-yellow-500 text-black font-bold">Day 1<br>‚Çπ1,000</div>
                    <div class="p-3 rounded-lg text-center bg-yellow-400/80 text-black font-bold">Day 2<br>‚Çπ2,000</div>
                    <div class="p-3 rounded-lg text-center bg-yellow-300/60 text-black font-bold">Day 3<br>‚Çπ3,000</div>
                    <div class="p-3 rounded-lg text-center bg-gray-700 text-white">Day 4<br>üîí</div>
                    <div class="p-3 rounded-lg text-center bg-gray-700 text-white">Day 5<br>üîí</div>
                    <div class="p-3 rounded-lg text-center bg-gray-700 text-white">Day 6<br>üîí</div>
                    <div class="p-3 rounded-lg text-center bg-gray-700 text-white">Day 7<br>üîí</div>
                  </div>
                </div>

                <!-- Current Progress Bar -->
                <div class="bg-gray-900 p-4 rounded-lg mb-4">
                  <p class="text-gray-400 text-sm mb-2">Today‚Äôs Target: ‚Çπ<span id="target-amount">1,00,000</span></p>
                  <div class="w-full bg-gray-700 h-4 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-yellow-400" style="width: 35%"></div>
                  </div>
                  <p class="text-xs text-right mt-1 text-gray-500">‚Çπ<span id="progress-amount">35,000</span> played today</p>
                </div>

                <!-- Info Box -->
                <div class="bg-yellow-900/40 border-l-4 border-yellow-400 p-4 rounded-md text-sm text-yellow-200">
                  <p>üéØ Play more battles today and unlock ‚Çπ<span id="next-reward">2,000</span> bonus on reaching target. Streak resets if you miss a day.</p>
                </div>
              </div>
            </div>
            <!-- Profile Page -->
            <div id="profile-page" class="page p-4 space-y-6">
                 <div class="bg-gray-800 rounded-lg p-6 flex flex-col items-center text-center">
                    <div class="relative group">
                        <div id="profile-page-avatar" class="w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center mb-2 overflow-hidden border-2 border-purple-500">
                           <i class="fas fa-user text-5xl text-gray-500"></i>
                        </div>
                        <label for="photo-upload-input" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-full cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                           <i class="fas fa-camera text-2xl text-white"></i>
                        </label>
                        <input type="file" id="photo-upload-input" class="hidden" accept="image/png, image/jpeg">
                    </div>
                    <button id="change-photo-btn" class="text-xs text-yellow-400 hover:underline mb-4">Change Photo</button>
                    
                    <div class="flex items-center justify-center space-x-2">
                        <h2 id="profile-name" class="text-2xl font-bold"></h2>
                        <button id="edit-name-btn" class="p-2 text-gray-400 hover:text-yellow-400">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                    </div>

                    <p id="profile-email" class="text-gray-400"></p>
                    <p id="profile-uid" class="text-xs text-gray-500 mt-2 bg-gray-900 px-2 py-1 rounded-full"></p>
                </div>

                <!-- Profile Stats Section -->
                <div id="profile-stats-section" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Stat Card: Cash Won -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üí∞</div>
                        <div>
                            <p class="text-gray-400 text-sm">Cash Won</p>
                            <p id="stat-cash-won" class="text-xl font-bold">‚Çπ0</p>
                            <div class="skeleton h-6 w-20 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                    <!-- Stat Card: Battle Played -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üé≤</div>
                        <div>
                            <p class="text-gray-400 text-sm">Battle Played</p>
                            <p id="stat-battles-played" class="text-xl font-bold">0</p>
                            <div class="skeleton h-6 w-16 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                    <!-- Stat Card: Referral Earning -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üîó</div>
                        <div>
                            <p class="text-gray-400 text-sm">Referral Earning</p>
                            <p id="stat-referral-earning" class="text-xl font-bold">‚Çπ0</p>
                            <div class="skeleton h-6 w-20 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                    <!-- Stat Card: Penalty -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">‚ùå</div>
                        <div>
                            <p class="text-gray-400 text-sm">Penalty</p>
                            <p id="stat-penalty" class="text-xl font-bold">‚Çπ0</p>
                            <div class="skeleton h-6 w-16 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                    <!-- Stat Card: July Winning Amount -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üóìÔ∏è</div>
                        <div>
                            <p class="text-gray-400 text-sm">July Winnings</p>
                            <p id="stat-july-winnings" class="text-xl font-bold">‚Çπ0</p>
                            <div class="skeleton h-6 w-20 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                    <!-- Stat Card: July Completed Games -->
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üéÆ</div>
                        <div>
                            <p class="text-gray-400 text-sm">July Games</p>
                            <p id="stat-july-games" class="text-xl font-bold">0</p>
                            <div class="skeleton h-6 w-16 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                     <!-- Stat Card: Refer Rank -->
                    <div class="stat-card col-span-2 md:col-span-1 bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl flex items-center space-x-4">
                        <div class="text-3xl">üèÜ</div>
                        <div>
                            <p class="text-gray-400 text-sm">Refer Rank</p>
                            <p id="stat-refer-rank" class="text-xl font-bold">#--</p>
                            <div class="skeleton h-6 w-16 bg-gray-700 rounded-md"></div>
                        </div>
                    </div>
                </div>

                 <div class="bg-gray-800 p-6 rounded-2xl space-y-4">
                    <h3 class="font-bold text-lg">Refer & Earn</h3>
                    <p class="text-gray-400">Your Referral Code</p>
                    <div class="my-2 p-3 bg-gray-900 border-2 border-dashed border-yellow-400 rounded-lg flex justify-between items-center">
                        <p id="referral-code-display" class="text-2xl font-bold tracking-widest text-yellow-400"></p>
                        <button id="copy-referral-btn"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
            <!-- Support Page -->
            <div id="support-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Support & Contact</h2>
                    <div class="space-y-4 text-gray-300 text-center max-w-md mx-auto">
                        <p class="text-lg">If you face any issue regarding payment, gameplay, or other matters, please reach out to us.</p>
                        <div class="bg-gray-900/50 p-4 rounded-lg space-y-3">
                            <div>
                                <h3 class="font-semibold text-yellow-400">Support Email</h3>
                                <p><a href="mailto:support@devilwin.online" class="hover:underline">support@devilwin.online</a></p>
                            </div>
                            <div>
                                <h3 class="font-semibold text-yellow-400">Response Time</h3>
                                <p>24‚Äì48 hours</p>
                            </div>
                            <div>
                                <h3 class="font-semibold text-yellow-400">Support Hours</h3>
                                <p>Monday ‚Äì Saturday, 10 AM ‚Äì 6 PM</p>
                            </div>
                        </div>
                         <p class="text-xs text-gray-400 pt-4">Please contact us within 48 hours of the issue for a timely resolution.</p>
                    </div>
                </div>
            </div>
            <!-- Terms & Conditions Page -->
            <div id="terms-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Terms & Conditions ‚Äì DevilWin</h2>
                    <div class="space-y-4 text-gray-300">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">1. Eligibility</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>You must be 18 years or older.</li>
                                <li>You must not be a resident of restricted states (Assam, Andhra Pradesh, Telangana, Odisha, Sikkim, Nagaland).</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">2. Account</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>You must log in via Google or Facebook.</li>
                                <li>Only one account per user is allowed.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">3. Game Rules</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>DevilWin is a Ludo-based skill game.</li>
                                <li>Users join matches with coins (entry fee).</li>
                                <li>The platform deducts a service fee from each entry.</li>
                                <li>Winner is declared based on performance and gameplay, not luck.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">4. Wallet & Payments</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Coins represent virtual currency.</li>
                                <li>Coins can be purchased or won.</li>
                                <li>Deposits and withdrawals are processed via UPI or supported methods.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">5. Refund & Disconnection</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>If a match doesn‚Äôt start, a full refund is given.</li>
                                <li>No refund is given after the game starts unless server issues occur.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">6. Fair Play</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Use of cheats, multiple accounts, bots, or tampering will result in account suspension.</li>
                                <li>DevilWin reserves the right to ban accounts involved in fraud.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">7. Platform Rights</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>We may modify rules, withdraw services, or close accounts at our sole discretion.</li>
                            </ul>
                        </div>
                         <div>
                            <h3 class="text-lg font-semibold mb-2">8. Governing Law</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>This agreement is governed by the laws of India.</li>
                                <li>Jurisdiction: Jaipur, Rajasthan.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">9. Contact</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Email: support@devilwin.online</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Privacy Policy Page -->
            <div id="privacy-policy-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Privacy Policy ‚Äì DevilWin</h2>
                    <div class="space-y-4 text-gray-300">
                        <p>We value your privacy.</p>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">1. Information We Collect</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Google/Facebook login info</li>
                                <li>IP address, device type, and gameplay data</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">2. How We Use Data</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>To provide, maintain, and improve the platform</li>
                                <li>To prevent fraud and ensure fair play</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">3. Data Security</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Your data is securely stored on Supabase servers</li>
                                <li>We do not sell or rent user data</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">4. User Rights</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>You may request account/data deletion anytime by emailing support@devilwin.online</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">5. Third-Party Services</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>We use Google, Facebook, and UPI providers ‚Äî they may collect basic session info</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">6. Contact</h3>
                            <ul class="list-disc list-inside pl-4 space-y-1">
                                <li>Email: support@devilwin.online</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Refund & Cancellation Policy Page -->
            <div id="refund-policy-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Refund & Cancellation Policy ‚Äì DevilWin</h2>
                    <p class="text-center text-gray-400 mb-6">We ensure fair refund practices. Please read carefully.</p>
                    <div class="space-y-6 text-gray-300">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-green-400">1. Refunds are allowed only in the following cases:</h3>
                            <ul class="list-disc list-inside pl-4 space-y-2">
                                <li><span class="font-bold">Match didn‚Äôt start due to no opponent:</span> Full refund</li>
                                <li><span class="font-bold">Server-side error or crash:</span> Full refund</li>
                                <li><span class="font-bold">Failed deposit:</span> Auto-refund in 5‚Äì7 working days</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-red-400">2. Refunds are NOT provided:</h3>
                            <ul class="list-disc list-inside pl-4 space-y-2">
                                <li>If user quits mid-match</li>
                                <li>If user has weak internet or disconnects</li>
                                <li>After game result is declared</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-yellow-400">3. Withdrawals:</h3>
                            <ul class="list-disc list-inside pl-4 space-y-2">
                                <li>Minimum withdrawal: ‚Çπ100</li>
                                <li>Withdrawal requests are processed within 24‚Äì48 hours</li>
                                <li>UPI details must be valid and belong to the same user</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-blue-400">4. Disputes:</h3>
                            <ul class="list-disc list-inside pl-4 space-y-2">
                                <li>Contact support within 24 hours of any transaction issue</li>
                                <li>Email: <a href="mailto:support@devilwin.online" class="text-yellow-400 hover:underline">support@devilwin.online</a></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">5. Final Decision:</h3>
                            <p>The platform reserves the right to make final decisions on all refund requests.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fair Play Policy Page -->
            <div id="fair-play-policy-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Fair Play Policy ‚Äì DevilWin</h2>
                    <div class="space-y-4 text-gray-300">
                        <p>We are committed to ensuring a fair and competitive environment for all users.</p>
                        <ul class="list-disc list-inside pl-4 space-y-2">
                            <li>Strict action will be taken against users found using hacks, bots, scripts, or any cheating mechanism.</li>
                            <li>Use of multiple accounts is prohibited.</li>
                            <li>AI tools, automation, or fraudulent behavior may result in permanent ban.</li>
                            <li>All matches are logged and reviewed for suspicious activity.</li>
                        </ul>
                        <p class="mt-4">Our anti-cheat engine runs 24x7. We may suspend, restrict, or delete user accounts without warning if violations are found.</p>
                    </div>
                </div>
            </div>
            <!-- About Us Page -->
            <div id="about-us-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">About DevilWin</h2>
                    <div class="space-y-4 text-gray-300">
                        <p>Welcome to DevilWin, India's premier destination for skill-based Ludo gaming. We believe in fair play, secure transactions, and providing an exciting platform for Ludo enthusiasts to test their strategies and win real rewards.</p>
                        <p>Our mission is to create a trusted gaming community where skill is celebrated. We use advanced technology to ensure a cheat-free environment and provide prompt customer support to resolve any issues you may face.</p>
                        <p>Join thousands of players and become a Ludo champion on DevilWin!</p>
                    </div>
                </div>
            </div>
            <!-- Skill Disclaimer Page -->
            <div id="skill-disclaimer-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Skill Game Disclaimer</h2>
                    <div class="space-y-4 text-gray-300">
                         <p>DevilWin is strictly a "Game of Skill" and is not considered "Gambling". The Supreme Court of India and various High Courts have recognized that games where the outcome is predominantly determined by a player's skill, knowledge, attention, and strategy, rather than by chance, are legal.</p>
                         <p>Ludo, as offered on our platform, requires significant skill. Players must make strategic decisions about which token to move, how to position their tokens to block opponents, and when to aim for home. These decisions directly impact the game's outcome, making it a game of skill.</p>
                         <p>By participating on DevilWin, you acknowledge that you are engaging in a game of skill for entertainment and potential rewards, and not participating in gambling.</p>
                    </div>
                </div>
            </div>
            <!-- Responsible Gaming Page -->
            <div id="responsible-gaming-page" class="page p-4">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">Responsible Gaming</h2>
                    <div class="space-y-4 text-gray-300">
                        <p>We are committed to promoting responsible gaming as a source of entertainment. It should not be viewed as a way to make money.</p>
                        <ul class="list-disc list-inside pl-4 space-y-1">
                            <li>Play for fun and entertainment, not as a source of income.</li>
                            <li>Set a budget for your gameplay and stick to it.</li>
                            <li>Do not chase losses.</li>
                            <li>Keep track of the time and money you spend.</li>
                            <li>Take regular breaks from gaming.</li>
                            <li>If you feel you are losing control, please stop playing and seek help. You can contact us to request a temporary or permanent deactivation of your account.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Transactions Page (NEW) -->
            <div id="transactions-page" class="page p-4">
                <div class="bg-gray-800 rounded-xl p-6">
                    <h2 class="text-2xl font-bold text-yellow-400 text-center mb-6">üìú Transaction History</h2>
                    <div id="transactions-list-container" class="space-y-3 max-h-[75vh] overflow-y-auto pr-2">
                        <p class="text-center text-gray-400">Loading history...</p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="p-4">
            <div class="glassmorphism p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">Quick Links</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                    <a href="#" id="footer-about-us-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó About Us</a>
                    <a href="#" id="footer-terms-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Terms & Conditions</a>
                    <a href="#" id="footer-privacy-policy-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Privacy Policy</a>
                    <a href="#" id="footer-skill-disclaimer-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Skill Disclaimer</a>
                    <a href="#" id="footer-refund-policy-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Refund Policy</a>
                    <a href="#" id="footer-fair-play-policy-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Fair Play Policy</a>
                    <a href="#" id="footer-contact-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Contact / Support</a>
                    <a href="#" id="footer-responsible-gaming-btn" class="text-gray-300 hover:text-yellow-400 transition-colors">üîó Responsible Gaming</a>
                </div>
            </div>
        </footer>

        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-md border-t border-gray-700 flex justify-around">
            <button data-tab="home" class="bottom-nav-item active flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-home text-xl mb-1"></i><span class="font-bold">Home</span></button>
            <button data-tab="battles" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-swords text-xl mb-1"></i><span class="font-bold">Battles</span></button>
            <button data-tab="transactions" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-history text-xl mb-1"></i><span class="font-bold">History</span></button>
            <button data-tab="achievement" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-trophy text-xl mb-1"></i><span class="font-bold">Rewards</span></button>
            <button data-tab="profile-nav" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-user text-xl mb-1"></i><span class="font-bold">Profile</span></button>
        </nav>
    </div>

    <!-- Authentication Container -->
    <div id="auth-container"></div>
    <!-- Modals Container -->
    <div id="modals-container"></div>
    <!-- Winner Animation Container -->
    <div id="winner-animation-container"></div>

    <script>
        // --- Supabase Initialization ---
        const SUPABASE_URL = 'https://mfkynknzyqgslwinstpm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ma3lua256eXFnc2x3aW5zdHBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzc2MzksImV4cCI6MjA2NzY1MzYzOX0._nC7-O4mnZ9bpbgdXvIcn3HAidjAooqh3bpy-iDeGW4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Helper Functions ---
        const showLudoLoader = (show = true) => {
            const loader = document.getElementById("ludo-loader");
            if (loader) {
                loader.classList.toggle("hidden", !show);
            }
        };

        showLudoLoader(true);

        // Global State
        let currentSession = null;
        let userData = null;
        let battlesChannel = null;
        let profileListener = null;
        let presenceInterval = null;
        let userDeposits = [];
        let hasPendingDeposit = false;
        let isUserInActiveBattle = false;
        
        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const authContainer = document.getElementById('auth-container');
        const modalsContainer = document.getElementById('modals-container');
        
        const generateReferralCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const generateAvatar = (seed = 'default', name = 'user') => {
            if (typeof name !== 'string' || !name) {
                name = 'user'; 
            }
            const femaleNames = ['priya', 'seema', 'pooja', 'sunita', 'geeta', 'neha', 'riya', 'sonia', 'mona', 'asha', 'rani', 'anita', 'kavita'];
            const firstName = name.split(' ')[0].toLowerCase();
            const gender = femaleNames.includes(firstName) ? 'female' : 'male';
            return `https://api.dicebear.com/8.x/personas/svg?seed=${seed}&sex=${gender}`;
        };

        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('global-alert');
            alertBox.classList.remove('hidden', 'border-green-500', 'border-red-500');
            alertBox.classList.add(isError ? 'border-red-500' : 'border-green-500');
            document.getElementById('global-alert-message').textContent = message;
            setTimeout(() => alertBox.classList.add('hidden'), 5000);
        }

        // Modal System
        const renderModal = (id, content) => {
            closeModal();
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = "modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4";
            modal.innerHTML = `<div class="modal-content glassmorphism rounded-2xl w-full max-w-sm p-6 relative">${content}</div>`;
            modalsContainer.appendChild(modal);
            modal.addEventListener('click', (e) => { 
                if (e.target.id === id) {
                    closeModal();
                }
            });
        };

        const closeModal = () => { modalsContainer.innerHTML = ''; };
        window.closeModal = closeModal;

        // --- Authentication System ---
        const renderAuthScreen = () => {
             authContainer.innerHTML = `
                <div class="p-6 flex flex-col justify-center min-h-screen">
                    <h1 class="text-5xl font-extrabold text-center mb-2 text-yellow-400 drop-shadow-lg">DevilWin</h1>
                    <p class="text-center text-gray-300 mb-8" id="auth-subtitle">Login to Your Kingdom</p>
                    <p id="auth-error" class="bg-red-500/20 text-red-300 p-3 rounded-lg mb-4 text-center hidden"></p>
                    
                    <button id="google-signin-btn" class="w-full max-w-xs mx-auto p-3 mb-4 bg-white text-gray-800 rounded-lg font-bold flex items-center justify-center hover:bg-gray-200 transition-colors">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">
                        Continue with Google
                    </button>

                    <div class="mt-8 text-xs text-gray-500 text-left p-4 glassmorphism rounded-lg max-w-xs mx-auto">
                        <h3 class="font-bold text-sm text-gray-300 mb-2">Skill Game Declaration ‚Äì DevilWin</h3>
                         <p>By playing on DevilWin, users confirm that they are playing a skill-based game, are 18 years or older, and are not from restricted states (Assam, Nagaland, Odisha, Sikkim, Telangana, Andhra Pradesh).</p>
                    </div>
                </div>
            `;
            attachAuthListeners();
        };

        async function handleGoogleSignIn() {
            showLudoLoader(true);
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) {
                showAlert(error.message, true);
                showLudoLoader(false);
            }
        }

        function attachAuthListeners() {
            const googleBtn = document.getElementById('google-signin-btn');
            if (googleBtn) {
                googleBtn.addEventListener('click', handleGoogleSignIn);
            }
        }
        
        // --- Wallet System ---
        
        function openWalletModal() {
            if (!userData) return;
            const totalBalance = (userData.total_amount || 0) + (userData.bonus || 0);

            const withdrawButtonDisabled = hasPendingDeposit;
            const withdrawButtonTooltip = withdrawButtonDisabled ? 'title="You have a pending deposit under review"' : '';
            const withdrawButtonClasses = withdrawButtonDisabled
                ? 'bg-gray-500 text-gray-300 cursor-not-allowed'
                : 'bg-yellow-500 text-black';
            
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Mera Wallet</h2>
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-xl mb-4">
                    <p class="text-sm text-gray-200">Total Balance</p>
                    <p class="text-3xl font-bold">‚Çπ${totalBalance.toFixed(2)}</p>
                </div>
                <div class="grid grid-cols-1 gap-2 text-center text-sm mb-4">
                    <div class="bg-gray-700 p-3 rounded-lg"><p class="text-gray-400">Total Amount</p><p class="font-bold text-lg">‚Çπ${(userData.total_amount || 0).toFixed(2)}</p></div>
                    <div class="bg-gray-700 p-3 rounded-lg"><p class="text-gray-400">Bonus</p><p class="font-bold text-lg">‚Çπ${(userData.bonus || 0).toFixed(2)}</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-deposit-modal" class="bg-green-600 p-3 rounded-lg font-bold">Add Money</button>
                    <div class="relative" ${withdrawButtonTooltip}>
                        <button id="open-withdraw-modal" class="${withdrawButtonClasses} p-3 rounded-lg font-bold w-full" ${withdrawButtonDisabled ? 'disabled' : ''}>Withdraw</button>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="open-history-modal" class="w-full bg-gray-600 p-3 rounded-lg font-bold">Transaction History</button>
                </div>
                <div class="mt-6 text-xs text-center text-gray-400 p-2 glassmorphism rounded-lg">
                    <p>üìå Play responsibly. Gaming is for entertainment and should not be seen as a source of income. Stop if you're losing control.</p>
                </div>
            `;
            renderModal('wallet-modal', content);
            document.getElementById('open-deposit-modal').addEventListener('click', openDepositModal);
            if (!withdrawButtonDisabled) {
                document.getElementById('open-withdraw-modal').addEventListener('click', openWithdrawModal);
            }
            document.getElementById('open-history-modal').addEventListener('click', openHistoryModal);
        }

        function openDepositModal() {
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Add Money</h2>
                <form id="deposit-amount-form">
                    <div class="mb-4">
                        <label for="deposit-amount" class="block text-sm font-medium text-gray-300 mb-2">Amount (‚Çπ)</label>
                        <input type="number" id="deposit-amount" placeholder="e.g., 500" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" required min="50">
                        <p class="text-xs text-gray-400 mt-2">Minimum deposit amount is ‚Çπ50.</p>
                    </div>
                    <button type="submit" id="generate-qr-btn" class="w-full mt-2 p-3 bg-yellow-500 text-black rounded-lg font-bold hover:bg-yellow-600 transition-colors">Generate QR Code</button>
                </form>
            `;
            renderModal('deposit-modal', content);
            document.getElementById('deposit-amount-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const amountInput = document.getElementById('deposit-amount');
                const amount = parseFloat(amountInput.value);
                if (!amount || amount < 50) {
                    showAlert("Kam se kam ‚Çπ50 deposit kar sakte hain.", true);
                    return;
                }
                showQrCodeStep(amount);
            });
        }

        function showQrCodeStep(amount) {
            const upiId = 'uttamdk99@ptaxis';
            const upiUrl = `upi://pay?pa=${upiId}&pn=DevilWin&am=${amount}&cu=INR`;

            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-2 text-center">Scan & Pay</h2>
                <p class="text-center text-gray-300 mb-4">Pay ‚Çπ${amount} using any UPI app.</p>
                
                <div id="qrcode-container" class="flex justify-center mb-4"></div>
                
                <div class="text-center my-4">
                    <p class="text-gray-400 text-sm">Or pay to this UPI ID:</p>
                    <div class="mt-1 p-2 bg-gray-900 border-2 border-dashed border-yellow-400 rounded-lg flex justify-between items-center">
                        <p id="upi-id-text" class="text-lg font-bold tracking-wider text-yellow-400">${upiId}</p>
                        <button id="copy-upi-id-btn"><i class="fas fa-copy"></i></button>
                    </div>
                </div>

                <form id="deposit-form">
                    <input type="hidden" id="deposit-amount-hidden" value="${amount}">
                    <div class="mb-4">
                        <label for="deposit-screenshot" class="block text-sm font-medium text-gray-300 mb-2">Payment Screenshot</label>
                        <input type="file" id="deposit-screenshot" accept="image/png, image/jpeg" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600" required>
                    </div>
                    <div class="bg-red-900/50 border-l-4 border-red-500 p-3 rounded-md text-sm text-red-200 mb-4">
                        <p>‚ö†Ô∏è Fake screenshot = ‚Çπ100 penalty + balance cut + ban risk</p>
                    </div>
                    <button type="submit" id="submit-deposit-btn" class="w-full mt-2 p-3 bg-green-600 rounded-lg font-bold text-white hover:bg-green-700 transition-colors">Submit Request</button>
                </form>
            `;
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
            }

            const qr = qrcode(0, 'M');
            qr.addData(upiUrl);
            qr.make();
            document.getElementById('qrcode-container').innerHTML = qr.createImgTag(5, 10);

            document.getElementById('deposit-form').addEventListener('submit', handleDepositSubmit);
            document.getElementById('copy-upi-id-btn').addEventListener('click', () => {
                if(navigator.clipboard) {
                    navigator.clipboard.writeText(upiId)
                        .then(() => showAlert('UPI ID copy ho gayi!'))
                        .catch(() => showAlert('Could not copy UPI ID.', true));
                }
            });
        }

        async function handleDepositSubmit(e) {
            e.preventDefault();
            const amountInput = document.getElementById('deposit-amount-hidden');
            const screenshotInput = document.getElementById('deposit-screenshot');
            const submitBtn = document.getElementById('submit-deposit-btn');

            const amount = parseFloat(amountInput.value);
            const screenshotFile = screenshotInput.files[0];

            if (!amount || amount < 50) {
                showAlert("Kam se kam ‚Çπ50 deposit kar sakte hain.", true); return;
            }
            if (!screenshotFile) {
                showAlert("Kripya payment ka screenshot upload karein.", true); return;
            }
            if (screenshotFile.size > 5 * 1024 * 1024) { // 5MB limit
                showAlert("Screenshot ka size 5 MB se kam hona chahiye.", true); return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

            try {
                // 1. Upload screenshot to Supabase Storage
                const userId = currentSession.user.id;
                const fileName = `${userId}/${Date.now()}_${screenshotFile.name}`;
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('deposit_proofs')
                    .upload(fileName, screenshotFile);
                
                if (uploadError) throw uploadError;

                // 2. Get public URL of the uploaded file
                const { data: urlData } = supabaseClient.storage
                    .from('deposit_proofs')
                    .getPublicUrl(fileName);
                
                const publicURL = urlData.publicUrl;

                // 3. Insert deposit request into the database
                const { error: insertError } = await supabaseClient.from('deposits').insert({
                    user_id: userId,
                    user_name: userData.display_name,
                    amount: amount,
                    screenshot_url: publicURL,
                    status: "pending",
                    type: "Deposit"
                });

                if (insertError) throw insertError;

                closeModal();
                showAlert("üïí Payment under review. Your balance will be updated on approval.");

            } catch (error) {
                console.error("Deposit submission failed:", error);
                showAlert("Request fail ho gayi. Kripya dobara try karein.", true);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Submit Request';
                }
            }
        }
        
        async function openWithdrawModal() {
            const totalAmount = userData.total_amount || 0;
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-2">Withdraw</h2>
                <p class="text-sm text-gray-400 mb-4">Aap ‚Çπ${totalAmount.toFixed(2)} tak nikal sakte hain. (Minimum ‚Çπ100)</p>
                <form id="withdraw-form">
                    <input type="number" id="withdraw-amount" placeholder="Amount" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required />
                    <input type="text" id="withdraw-upi" value="${userData.upi_id || ''}" placeholder="Aapki UPI ID" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required />
                    <div id="fee-details" class="text-xs text-gray-400 space-y-1 mt-2 hidden">
                        <div class="flex justify-between"><span>Transaction Fee (5%):</span><span id="fee-amount">‚Çπ0.00</span></div>
                        <div class="flex justify-between font-bold text-white"><span>Aapko milenge:</span><span id="net-amount">‚Çπ0.00</span></div>
                    </div>
                    <button type="submit" class="w-full mt-4 p-3 bg-yellow-500 text-black rounded-lg font-bold">Withdraw Karein</button>
                </form>
                <div class="mt-6 text-xs text-center text-gray-400 p-2 glassmorphism rounded-lg">
                    <p>üìå Withdrawals are processed within 24-48 hours. Please ensure your UPI ID is correct.</p>
                </div>
            `;
            renderModal('withdraw-modal', content);

            const amountInput = document.getElementById('withdraw-amount');
            amountInput.addEventListener('input', (e) => {
                const amount = parseFloat(e.target.value) || 0;
                const feeDetails = document.getElementById('fee-details');
                if (amount > 0) {
                    const fee = amount * 0.05;
                    const netAmount = amount - fee;
                    document.getElementById('fee-amount').textContent = `‚Çπ${fee.toFixed(2)}`;
                    document.getElementById('net-amount').textContent = `‚Çπ${netAmount.toFixed(2)}`;
                    feeDetails.classList.remove('hidden');
                } else {
                    feeDetails.classList.add('hidden');
                }
            });

            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawRequest);
        }

        async function handleWithdrawRequest(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const upiId = document.getElementById('withdraw-upi').value;
            const totalAmountBalance = userData.total_amount || 0;

            if (!amount || !upiId || amount <= 0) { showAlert("Kripya sahi amount aur UPI ID daalein.", true); return; }
            if (amount < 100) { showAlert("Kam se kam ‚Çπ100 nikal sakte hain.", true); return; }
            if (amount > totalAmountBalance) { showAlert("Aapke paas itne paise nahi hain.", true); return; }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = 'Processing...';
            try {
                // Calling the RPC function created in the SQL setup script
                const { error } = await supabaseClient.rpc('request_withdrawal', {
                    request_amount: amount,
                    upi_id: upiId
                });

                if (error) throw error;

                closeModal();
                showAlert("Aapki withdrawal request bhej di gayi hai.");
            } catch (error) {
                showAlert(`Request fail ho gayi: ${error.message || error}`, true);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Withdraw Karein';
            }
        }
        
        // --- Transaction History Logic ---
        async function getAndRenderTransactions(container) {
            if (!container || !currentSession) {
                if(container) container.innerHTML = '<p class="text-center text-gray-400">Please log in to see history.</p>';
                return;
            };
            
            container.innerHTML = '<p class="text-center text-gray-400">Loading history...</p>';
            const userId = currentSession.user.id;

            try {
                const { data: withdrawalsData, error: wError } = await supabaseClient
                    .from('withdrawals')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                const { data: depositsData, error: dError } = await supabaseClient
                    .from('deposits')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (wError) throw wError;
                if (dError) throw dError;
                
                const transactions = [...depositsData, ...withdrawalsData];
                transactions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                let historyHtml = '';
                if (transactions.length === 0) {
                    historyHtml = '<p class="text-center text-gray-400">No transactions yet.</p>';
                } else {
                    historyHtml = transactions.map(tx => {
                        const isDeposit = tx.type === 'Deposit';
                        const amount = isDeposit ? tx.amount : tx.gross_amount;
                        const status = tx.status;
                        const date = new Date(tx.created_at).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });

                        let statusClass = '';
                        let statusIcon = '';
                        switch (status) {
                            case 'pending': statusClass = 'text-yellow-400'; statusIcon = '<i class="fas fa-clock mr-2"></i>'; break;
                            case 'approved': case 'completed': statusClass = 'text-green-400'; statusIcon = '<i class="fas fa-check-circle mr-2"></i>'; break;
                            case 'rejected': statusClass = 'text-red-400'; statusIcon = '<i class="fas fa-times-circle mr-2"></i>'; break;
                            default: statusClass = 'text-gray-400';
                        }

                        return `
                            <div class="history-item glassmorphism p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-bold">${tx.type}</p>
                                    <p class="text-xs text-gray-400">${date}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg ${isDeposit ? 'text-green-400' : 'text-red-400'}">
                                       ${isDeposit ? '+' : '-'}‚Çπ${(amount || 0).toFixed(2)}
                                    </p>
                                    <p class="text-sm capitalize ${statusClass}">${statusIcon}${status}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                container.innerHTML = historyHtml;

            } catch (error) {
                console.error("Error fetching transactions:", error);
                container.innerHTML = '<p class="text-center text-red-500">Could not load transaction history.</p>';
            }
        }

        async function openHistoryModal() {
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Transaction History</h2>
                <div id="history-modal-container" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Content will be loaded here -->
                </div>
            `;
            renderModal('history-modal', content);
            const container = document.getElementById('history-modal-container');
            getAndRenderTransactions(container);
        }

        async function renderTransactionsPage() {
            const container = document.getElementById('transactions-list-container');
            getAndRenderTransactions(container);
        }

        // --- Battle System ---
        function openCreateBattleModal() {
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Create a New Battle</h2>
                <form id="create-battle-form">
                    <input type="number" id="battle-amount" placeholder="Amount (e.g., 50)" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required min="2" />
                    <p class="text-xs text-gray-400 mb-4">Minimum amount is ‚Çπ2. Must be a whole number.</p>
                    <button type="submit" class="w-full mt-4 p-3 bg-green-600 rounded-lg font-bold">Create Battle</button>
                </form>
            `;
            renderModal('create-battle-modal', content);
            document.getElementById('create-battle-form').addEventListener('submit', handleCreateBattle);
        }

        async function handleCreateBattle(e) {
            e.preventDefault();
            const amountInput = document.getElementById('battle-amount');
            const amount = Number(amountInput.value);

            if (!amount || amount < 2 || parseInt(amount) !== amount) {
                showAlert("Invalid amount. Minimum is ‚Çπ2 and must be a whole number.", true);
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            showLudoLoader(true);

            try {
                const { error } = await supabaseClient.rpc('create_battle', { p_entry_amount: amount });
                if (error) throw error;
                closeModal();
                showAlert("Your battle has been created!");
            } catch (error) {
                showAlert(`Failed to create battle: ${error.message}`, true);
            } finally {
                showLudoLoader(false);
                if(submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Battle';
                }
            }
        }
        
        async function handleJoinBattle(battleId) {
            showLudoLoader(true);
            try {
                const { error } = await supabaseClient.rpc('join_battle', { p_battle_id: battleId });
                if (error) throw error;
                showAlert("Battle joined! Waiting for the creator to add the room code.");
            } catch (error) {
                showAlert(`Failed to join: ${error.message}`, true);
            } finally {
                showLudoLoader(false);
            }
        }

        async function handleCancelBattle(battleId) {
             showLudoLoader(true);
            try {
                const { error } = await supabaseClient.rpc('cancel_battle', { p_battle_id: battleId });
                if (error) throw error;
                showAlert("Battle cancelled and amount refunded.");
            } catch (error) {
                showAlert(`Could not cancel battle: ${error.message}`, true);
            } finally {
                showLudoLoader(false);
            }
        }

        function openAddRoomCodeModal(battleId) {
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Enter Room Code</h2>
                <p class="text-sm text-gray-400 mb-4">Your opponent has joined. Please enter the Ludo King Room Code to start.</p>
                <form id="add-room-code-form">
                    <input type="text" id="ludo-code-input" placeholder="Ludo King Room Code" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required />
                    <button type="submit" class="w-full mt-4 p-3 bg-green-600 rounded-lg font-bold">Submit Code & Start</button>
                </form>
            `;
            renderModal('add-room-code-modal', content);
            document.getElementById('add-room-code-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const ludoCode = document.getElementById('ludo-code-input').value;
                if (!ludoCode.trim()) {
                    showAlert("Please enter a valid Ludo King room code.", true);
                    return;
                }
                const { error } = await supabaseClient
                    .from('battles')
                    .update({ room_code: ludoCode.trim(), status: 'live' })
                    .eq('id', battleId);

                if (error) {
                    showAlert(`Error: ${error.message}`, true);
                } else {
                    closeModal();
                    showAlert("Room code submitted! The battle is now live.");
                }
            });
        }

        function openWinClaimModal(battleId, opponentId) {
             const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Claim Your Victory</h2>
                <div class="bg-yellow-900/50 border-l-4 border-yellow-400 p-3 rounded-lg mb-4">
                    <p class="text-sm text-yellow-200">
                       <b>‚ö†Ô∏è Warning:</b> Uploading a fake screenshot will result in a ‚Çπ50 penalty.
                    </p>
                </div>
                <form id="win-claim-form" data-battle-id="${battleId}" data-opponent-id="${opponentId}">
                    <input type="file" id="win-proof" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600" required />
                    <button type="submit" class="w-full mt-4 p-3 bg-green-600 rounded-lg font-bold">Claim Victory</button>
                </form>
            `;
            renderModal('win-claim-modal', content);
            document.getElementById('win-claim-form').addEventListener('submit', submitWinClaim);
        }

        async function submitWinClaim(e) {
            e.preventDefault();
            const battleId = e.target.dataset.battleId;
            const opponentId = e.target.dataset.opponentId;
            const proofFile = document.getElementById('win-proof').files[0];
            if (!proofFile) { showAlert("A screenshot is required to claim victory.", true); return; }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // For simplicity, we directly resolve the battle. A real app would have a confirmation step.
                const { error } = await supabaseClient.rpc('resolve_battle', { p_battle_id: battleId, p_winner_id: currentSession.user.id });
                if (error) throw error;
                
                closeModal();
                showWinnerAnimation();

            } catch (error) {
                showAlert(`Failed to submit claim: ${error.message}`, true);
                submitBtn.disabled = false; submitBtn.innerHTML = 'Claim Victory';
            }
        }

        async function handleLostClaim(battleId, opponentId) {
            const { error } = await supabaseClient.rpc('resolve_battle', { p_battle_id: battleId, p_winner_id: opponentId });
            if (error) {
                showAlert(`Error: ${error.message}`, true);
            }
        }
        
        function listenToBattles() {
            if (battlesChannel) {
                battlesChannel.unsubscribe();
            }
            battlesChannel = supabaseClient.channel('public:battles')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'battles' }, payload => {
                    renderBattles();
                })
                .subscribe();
            renderBattles();
        }

        async function renderBattles() {
            if(!currentSession) return; // Don't render if not logged in
            const { data: battles, error } = await supabaseClient
                .from('battles')
                .select('*')
                .in('status', ['active', 'live', 'pending_confirmation']);
            
            if (error) {
                console.error("Error fetching battles:", error);
                return;
            }

            const openBattlesList = document.getElementById('active-battles-list');
            const myBattlesList = document.getElementById('live-battles-list');
            const createBattleBtn = document.getElementById('create-battle-btn');
            openBattlesList.innerHTML = '';
            myBattlesList.innerHTML = '';
            let openCount = 0, myBattleCount = 0;
            
            isUserInActiveBattle = battles.some(b => b.created_by === currentSession.user.id || b.joined_by === currentSession.user.id);
            if (createBattleBtn) createBattleBtn.disabled = isUserInActiveBattle;

            battles.forEach(battle => {
                const isCreator = battle.created_by === currentSession.user.id;
                const isJoiner = battle.joined_by === currentSession.user.id;
                const isMyBattle = isCreator || isJoiner;

                if (isMyBattle) {
                    myBattleCount++;
                    myBattlesList.appendChild(createMyBattleCard(battle, isCreator));
                } else if (battle.status === 'active' && !battle.joined_by) {
                    openCount++;
                    openBattlesList.appendChild(createOpenBattleCard(battle));
                }
            });

            if (openCount === 0) openBattlesList.innerHTML = '<p class="text-center text-gray-500">No open battles. Create one!</p>';
            if (myBattleCount === 0) myBattlesList.innerHTML = '<p class="text-center text-gray-500">You are not in any battle right now.</p>';
        }

        function createMyBattleCard(battle, isCreator) {
            const card = document.createElement('div');
            card.className = 'glassmorphism p-4 rounded-lg flex justify-between items-center';
            const opponentName = isCreator ? battle.joiner_name : battle.creator_name;
            let statusText = '', buttonsHTML = '';

            switch(battle.status) {
                case 'active':
                    if (battle.joined_by) { // Opponent joined, waiting for code
                        statusText = `Opponent ${opponentName} joined. Add room code.`;
                        if (isCreator) {
                            buttonsHTML = `<button class="add-code-btn bg-blue-500 text-white font-bold py-2 px-4 rounded" data-id="${battle.id}">Add Code</button>`;
                        } else {
                            buttonsHTML = `<span class="text-sm text-gray-400 animate-pulse">Waiting for code...</span>`;
                        }
                    } else { // Waiting for opponent
                        statusText = 'Waiting for an opponent...';
                        buttonsHTML = `<button class="creator-cancel-btn bg-red-600 text-white font-bold py-2 px-4 rounded" data-id="${battle.id}">Cancel</button>`;
                    }
                    break;
                case 'live':
                    statusText = `<span class="font-bold text-white">Code: ${battle.room_code}</span>`;
                    const opponentId = isCreator ? battle.joined_by : battle.created_by;
                    buttonsHTML = `
                        <button class="win-claim-btn bg-green-500 text-white font-bold py-1 px-3 rounded text-sm" data-id="${battle.id}" data-opponent-id="${opponentId}">I Won</button>
                    `;
                    break;
                // Other statuses like 'pending_confirmation' can be added here
            }

            card.innerHTML = `
                <div class="flex-1 min-w-0">
                    <p class="font-bold truncate">${isCreator ? 'You' : battle.creator_name} <span class="text-red-500">vs</span> ${isCreator ? (opponentName || 'Waiting...') : 'You'}</p>
                    <p class="text-sm text-yellow-400">Amount: ‚Çπ${battle.entry_amount}</p>
                    <p class="text-xs text-gray-400">${statusText}</p>
                </div>
                <div class="flex-shrink-0 ml-2 flex items-center">${buttonsHTML}</div>`;
            return card;
        }

        function createOpenBattleCard(battle) {
            const card = document.createElement('div');
            card.className = 'glassmorphism p-4 rounded-lg flex justify-between items-center';
            card.innerHTML = `
                <div>
                    <p class="font-bold">${battle.creator_name}</p>
                    <p class="text-sm text-yellow-400">Amount: ‚Çπ${battle.entry_amount}</p>
                </div>
                <button class="join-battle-btn bg-green-500 text-white font-bold py-2 px-4 rounded" data-id="${battle.id}" ${isUserInActiveBattle ? 'disabled' : ''}>Join</button>
            `;
            return card;
        }

        function showWinnerAnimation() {
            const container = document.getElementById('winner-animation-container');
            container.innerHTML = `<div class="winner-animation"><i class="fas fa-crown"></i><p>YOU WON!</p></div>`;
            setTimeout(() => { container.innerHTML = ''; }, 4000);
        }
        
        // --- Leaderboard Logic ---
        async function listenToDailyLeaderboard() {
            const realPlayersContainer = document.getElementById('leaderboard-real');
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('id, display_name, photo_url, total_winnings')
                    .order('total_winnings', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                if(!realPlayersContainer) return;
                
                if (data.length === 0) {
                    realPlayersContainer.innerHTML = '<p class="text-center text-gray-400">No live rankings yet.</p>';
                    return;
                }

                realPlayersContainer.innerHTML = data.map((player, index) => {
                    const rank = index + 1;
                    const avatar = player.photo_url || generateAvatar(player.id, player.display_name);
                    return `
                        <div class="flex items-center glassmorphism p-2 rounded-lg">
                            <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold mr-3">#${rank}</div>
                            <img src="${avatar}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <div class="flex-grow">
                                <p class="font-bold truncate">${player.display_name || 'Anonymous'}</p>
                            </div>
                            <p class="font-bold text-yellow-400">‚Çπ${(player.total_winnings || 0).toFixed(2)}</p>
                        </div>
                    `;
                }).join('');


            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                if(realPlayersContainer) realPlayersContainer.innerHTML = '<p class="text-center text-red-500">Could not load rankings.</p>';
            }
        }
        
        // --- App Navigation & Initialization ---
        function navigateToPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                 targetPage.classList.add('active');
            }
            window.scrollTo(0, 0);
            
            const tabId = pageId.replace('-page', '');
            const navItem = document.querySelector(`.bottom-nav-item[data-tab="${tabId}"]`) || document.querySelector(`.bottom-nav-item[data-tab="${tabId}-nav"]`);
            document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
            if(navItem) {
                navItem.classList.add('active');
            } else {
                 document.querySelector('.bottom-nav-item[data-tab="home"]').classList.add('active');
            }

            if (pageId === 'profile-page') {
                // updateProfileStats();
            }
            if (pageId === 'transactions-page') {
                renderTransactionsPage();
            }
        }

        function initializeMainApp() {
            if (document.getElementById('home-page').classList.contains('initialized')) return;
            document.getElementById('home-page').classList.add('active', 'initialized');
            
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.dataset.tab.replace('-nav', '');
                    navigateToPage(`${tabId}-page`);
                });
            });
             document.getElementById('logout-btn').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
             });
             document.getElementById('header-wallet-btn').addEventListener('click', openWalletModal);
             document.getElementById('create-battle-btn').addEventListener('click', openCreateBattleModal);

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const { id, opponentId } = target.dataset;

                if (target.classList.contains('join-battle-btn')) handleJoinBattle(id);
                if (target.classList.contains('creator-cancel-btn')) handleCancelBattle(id);
                if (target.classList.contains('add-code-btn')) openAddRoomCodeModal(id);
                if (target.classList.contains('win-claim-btn')) openWinClaimModal(id, opponentId);
            });

            updateUIWithUserData();
            listenToBattles();
            listenToDailyLeaderboard();
        }

        function updateUIWithUserData() {
             if (!userData || !currentSession) return;
            const totalBalance = (userData.total_amount || 0) + (userData.bonus || 0);
            document.getElementById('header-wallet-balance').textContent = `‚Çπ${totalBalance.toFixed(2)}`;
            
            document.getElementById('profile-name').textContent = userData.display_name || 'User';
            document.getElementById('profile-email').textContent = currentSession.user.email;
            
            if (document.getElementById('referral-code-display')) {
                document.getElementById('referral-code-display').textContent = userData.referral_code;
            }
            if (document.getElementById('profile-uid')) {
                document.getElementById('profile-uid').textContent = `ID: ${currentSession.user.id}`;
            }

            const avatarUrl = userData.photo_url || generateAvatar(currentSession.user.id, userData.display_name);
            const headerAvatarImg = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover">`;
            const profileAvatarImg = `<img src="${avatarUrl}" class="w-24 h-24 rounded-full object-cover">`;
            
            document.getElementById('header-profile-btn').innerHTML = headerAvatarImg;
            if (document.getElementById('profile-page-avatar')) {
                document.getElementById('profile-page-avatar').innerHTML = profileAvatarImg;
            }
        }

        // --- Main Auth Listener ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            currentSession = session;
            if (session) {
                // User is signed in
                let { data: profile, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (error && error.code === 'PGRST116') { // PGRST116 means no rows found
                    console.log('No profile found for user, creating one.');
                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: session.user.id,
                            email: session.user.email,
                            display_name: session.user.user_metadata?.display_name || session.user.email.split('@')[0],
                            photo_url: session.user.user_metadata?.avatar_url,
                            referral_code: generateReferralCode()
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error("Error creating user profile:", insertError);
                        showAlert("Could not create your profile.", true);
                        showLudoLoader(false);
                        return;
                    }
                    profile = newProfile;
                } else if (error) {
                    console.error("Error fetching user profile:", error);
                    showAlert("Could not load your profile.", true);
                    showLudoLoader(false);
                    return;
                }
                
                userData = profile;

                // Listen for profile changes
                if (profileListener) profileListener.unsubscribe();
                profileListener = supabaseClient.channel(`public:users:id=eq.${session.user.id}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, payload => {
                        console.log('Profile updated:', payload.new);
                        userData = payload.new;
                        updateUIWithUserData();
                    })
                    .subscribe();

                authContainer.innerHTML = '';
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                initializeMainApp();
                showLudoLoader(false);

            } else {
                // User is signed out
                if (profileListener) profileListener.unsubscribe();
                profileListener = null;
                userData = null;
                
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
                const homePage = document.getElementById('home-page');
                if(homePage) homePage.classList.remove('initialized');
                renderAuthScreen();
                showLudoLoader(false);
            }
        });

    </script>
</body>
</html>
