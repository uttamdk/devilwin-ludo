<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DevilWin - Kheliye aur Jeetiye</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #1a0b2e; color: #f0f0f0; }
        .ludo-bg-pattern { background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 15px 15px; }
        .glassmorphism { background: rgba(40, 25, 65, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bottom-nav-item.active { color: #facc15; }
        #qrcode-container img { background: white; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body class="ludo-bg-pattern">

    <div id="global-alert" class="hidden fixed top-5 left-1/2 -translate-x-1/2 glassmorphism p-3 rounded-full shadow-lg z-[100] border-l-4 max-w-sm w-full">
        <p id="global-alert-message" class="text-center text-sm font-medium text-white"></p>
    </div>

    <div id="app-container" class="hidden">
        <header class="p-3 flex justify-between items-center bg-gray-900/50 backdrop-blur-md sticky top-0 z-20 border-b border-gray-700">
            <h1 class="text-2xl font-extrabold text-yellow-400 drop-shadow-lg">DevilWin</h1>
            <div class="flex items-center space-x-4">
                <button id="header-wallet-btn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold px-4 py-2 rounded-full shadow-lg flex items-center">
                    <i class="fas fa-wallet mr-2"></i><span id="header-wallet-balance">₹0.00</span>
                </button>
                <div class="relative">
                    <button id="header-profile-btn" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                         <i class="fas fa-user text-xl text-gray-300"></i>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-50">
                        <a href="#" id="profile-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Profile</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="pb-20">
            <!-- Home Page -->
            <div id="home-page" class="page p-4 space-y-6">
                 <div class="bg-gradient-to-br from-red-600 to-purple-700 p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold">Ludo King Battles</h2>
                    <p class="text-purple-200 mb-4">Create or Join Rooms & Win Big!</p>
                    <button id="view-battles-btn" class="bg-white text-black font-bold px-8 py-3 rounded-full shadow-md hover:scale-105 transition-transform">View All Battles</button>
                </div>
            </div>
            <!-- Battles Page -->
            <div id="battles-page" class="page p-4 space-y-6">
                 <div class="flex justify-end">
                    <button id="create-battle-btn" class="bg-gradient-to-r from-red-500 to-yellow-500 text-white font-bold px-6 py-2 rounded-lg">Create Battle</button>
                </div>
                <!-- Live Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-satellite-dish text-red-500 mr-2 animate-pulse"></i>Live Battles</h2>
                    <div id="live-battles-list" class="space-y-3"></div>
                </div>
                <!-- Active Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2">Active Battles</h2>
                    <div id="active-battles-list" class="space-y-3"></div>
                </div>
            </div>
            <!-- Profile Page -->
            <div id="profile-page" class="page p-4">
                 <div class="bg-gray-800 rounded-lg p-6 flex flex-col items-center">
                    <img id="profile-page-avatar" class="w-24 h-24 rounded-full bg-gray-700 mb-4">
                    <div class="flex items-center">
                        <h2 id="profile-name" class="text-2xl font-bold"></h2>
                    </div>
                    <p id="profile-email" class="text-gray-400"></p>
                </div>
                 <div class="grid grid-cols-2 gap-4 mt-6 text-center">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400">Cash Won</p>
                        <p id="profile-cash-won" class="text-2xl font-bold text-green-400">₹0</p>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400">Battles Played</p>
                        <p id="profile-battles-played" class="text-2xl font-bold">0</p>
                    </div>
                 </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-md border-t border-gray-700 flex justify-around">
            <button data-tab="home" class="bottom-nav-item active flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-home text-xl mb-1"></i><span class="font-bold">Home</span></button>
            <button data-tab="battles" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-swords text-xl mb-1"></i><span class="font-bold">Battles</span></button>
            <button data-tab="profile" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-user text-xl mb-1"></i><span class="font-bold">Profile</span></button>
        </nav>
    </div>

    <div id="auth-container"></div>
    <div id="modals-container"></div>

    <script type="module">
        // --- IMPORTANT: PASTE YOUR SUPABASE URL AND ANON KEY HERE ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        // -----------------------------------------------------------
        
        const dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Global State & Constants ---
        let currentUser = null;
        let userData = null;
        let unsubscribeUser = null; 
        const UPI_ID = 'uttamdk99@ptaxis';
        const PAYEE_NAME = 'DevilWin';
        
        // --- UI Elements ---
        const appContainer = document.getElementById('app-container');
        const authContainer = document.getElementById('auth-container');
        const modalsContainer = document.getElementById('modals-container');
        
        // --- Helper Functions ---
        const generateAvatar = (seed = 'default') => `https://api.dicebear.com/8.x/adventurer/svg?seed=${seed}`;
        function showAlert(message, isError = false) { /* ... same as before ... */ }
        const renderModal = (id, content) => { /* ... same as before ... */ };
        const closeModal = () => { modalsContainer.innerHTML = ''; };
        window.closeModal = closeModal;

        // --- Authentication ---
        const renderAuthScreen = () => {
            authContainer.innerHTML = `<div class="p-6 flex flex-col justify-center min-h-screen"><h1 class="text-5xl font-extrabold text-center mb-2 text-yellow-400 drop-shadow-lg">DevilWin</h1><p class="text-center text-gray-300 mb-8" id="auth-subtitle">Login to Your Kingdom</p><p id="auth-error" class="bg-red-500/20 text-red-300 p-3 rounded-lg mb-4 text-center hidden"></p><form id="auth-form" class="space-y-4"><div id="name-field" class="hidden"><input type="text" placeholder="Aapka Poora Naam" id="auth-name" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" /></div><input type="email" placeholder="Email" id="auth-email" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" required /><input type="password" placeholder="Password" id="auth-password" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" required /><button type="submit" id="auth-submit-btn" class="w-full p-3 bg-gradient-to-r from-red-500 to-yellow-500 rounded-lg font-bold text-white hover:opacity-90 transition-opacity disabled:opacity-50">Login</button></form><p class="text-center mt-6 text-gray-400"><span id="auth-toggle-text">Naye khiladi hain?</span><button id="auth-toggle-btn" class="text-yellow-400 font-bold ml-2 hover:underline">Sign Up</button></p></div>`;
            attachAuthListeners();
        };

        function attachAuthListeners() {
            let isLogin = true;
            const form = document.getElementById('auth-form');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            
            toggleBtn.addEventListener('click', () => {
                isLogin = !isLogin;
                document.getElementById('name-field').classList.toggle('hidden', isLogin);
                document.getElementById('auth-subtitle').textContent = isLogin ? 'Login Karein' : 'Account Banayein';
                toggleBtn.textContent = isLogin ? "Sign Up" : "Login";
                document.getElementById('auth-submit-btn').textContent = isLogin ? "Login" : "Sign Up";
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const name = document.getElementById('auth-name').value;
                const errorEl = document.getElementById('auth-error');
                errorEl.classList.add('hidden');

                try {
                    if (isLogin) {
                        const { error } = await dbClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        if (!name.trim()) throw new Error("Kripya apna naam daalein.");
                        const { data: { user }, error } = await dbClient.auth.signUp({ email, password, options: { data: { name: name.trim() } } });
                        if (error) throw error;
                        
                        // Create user profile in 'users' table
                        const { error: profileError } = await dbClient.from('users').insert({
                            id: user.id,
                            name: name.trim(),
                            email: user.email,
                            wallet: { cash: 0, bonus: 10, winnings: 0 } // Signup bonus
                        });
                        if (profileError) throw profileError;
                    }
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                }
            });
        }
        
        // --- Wallet & Transactions ---
        function openWalletModal() {
            if (!userData) return;
            const wallet = userData.wallet || { cash: 0, bonus: 0, winnings: 0 };
            const totalBalance = wallet.cash + wallet.winnings + wallet.bonus;
            const content = `<button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button><h2 class="text-xl font-bold mb-4">Mera Wallet</h2><div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-xl mb-4"><p class="text-sm text-gray-200">Total Balance</p><p class="text-3xl font-bold">₹${totalBalance.toFixed(2)}</p></div><div class="grid grid-cols-2 gap-2 text-center text-sm mb-4"><div class="bg-gray-700 p-2 rounded-lg"><p class="text-gray-400">Cash</p><p class="font-bold">₹${wallet.cash.toFixed(2)}</p></div><div class="bg-gray-700 p-2 rounded-lg"><p class="text-gray-400">Winnings</p><p class="font-bold">₹${wallet.winnings.toFixed(2)}</p></div><div class="bg-gray-700 p-2 rounded-lg col-span-2"><p class="text-gray-400">Bonus</p><p class="font-bold">₹${wallet.bonus.toFixed(2)}</p></div></div><div class="grid grid-cols-2 gap-4"><button id="open-deposit-modal" class="bg-green-600 p-3 rounded-lg font-bold">Paise Daalein</button><button id="open-withdraw-modal" class="bg-yellow-500 text-black p-3 rounded-lg font-bold">Paise Nikalein</button></div>`;
            renderModal('wallet-modal', content);
            document.getElementById('open-deposit-modal').addEventListener('click', openDepositModal);
            document.getElementById('open-withdraw-modal').addEventListener('click', openWithdrawModal);
        }

        function openDepositModal() {
            const content = `<button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button><h2 class="text-xl font-bold mb-4">Paise Daalein</h2><div id="deposit-step-1"><p class="text-sm text-gray-300 mb-2">Aap kitne paise daalna chahte hain? (Minimum ₹50)</p><input type="number" id="deposit-amount" placeholder="Amount (e.g., 100)" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" /><button id="generate-qr-btn" class="w-full mt-2 p-3 bg-indigo-600 rounded-lg font-bold">QR Code Banayein</button></div><div id="deposit-step-2" class="hidden text-center"><p class="text-sm text-gray-300 mb-2">Is QR code ko scan karke payment karein</p><div id="qrcode-container" class="flex justify-center my-3"></div><form id="deposit-proof-form"><label class="block text-sm text-gray-400 my-3">Payment ka screenshot upload karein:</label><input type="file" id="deposit-proof" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600" required /><p class="text-xs text-yellow-400 my-2">Warning: Galat screenshot par ₹100 penalty lagegi.</p><button type="submit" class="w-full mt-2 p-3 bg-green-600 rounded-lg font-bold">Request Jama Karein</button></form></div>`;
            renderModal('deposit-modal', content);
            document.getElementById('generate-qr-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('deposit-amount').value);
                if (!amount || amount < 50) { showAlert("Kam se kam ₹50 deposit kar sakte hain.", true); return; }
                generateUpiQrCode(amount);
            });
            document.getElementById('deposit-proof-form').addEventListener('submit', handleDepositRequest);
        }

        function generateUpiQrCode(amount) {
            const upiString = `upi://pay?pa=${UPI_ID}&pn=${PAYEE_NAME}&am=${amount.toFixed(2)}&cu=INR&tn=Deposit for DevilWin`;
            const qr = qrcode(0, 'L');
            qr.addData(upiString);
            qr.make();
            document.getElementById('qrcode-container').innerHTML = qr.createImgTag(5, 10);
            document.getElementById('deposit-step-1').classList.add('hidden');
            document.getElementById('deposit-step-2').classList.remove('hidden');
        }

        async function handleDepositRequest(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const proofFile = document.getElementById('deposit-proof').files[0];
            if (!proofFile) { showAlert("Kripya screenshot upload karein.", true); return; }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.innerHTML = 'Uploading...';

            try {
                // 1. Upload screenshot to Supabase Storage
                const filePath = `${currentUser.id}/${Date.now()}_${proofFile.name}`;
                const { error: uploadError } = await dbClient.storage.from('deposits').upload(filePath, proofFile);
                if (uploadError) throw uploadError;

                // 2. Get public URL
                const { data: { publicUrl } } = dbClient.storage.from('deposits').getPublicUrl(filePath);

                // 3. Insert deposit request
                const { error: dbError } = await dbClient.from('deposits').insert({
                    user_id: currentUser.id, user_name: userData.name, amount, screenshot_url: publicUrl
                });
                if (dbError) throw dbError;

                // 4. Add amount to user wallet instantly
                const newBalance = (userData.wallet.cash || 0) + amount;
                const { error: updateError } = await dbClient.from('users').update({ wallet: { ...userData.wallet, cash: newBalance } }).eq('id', currentUser.id);
                if (updateError) throw updateError;
                
                closeModal();
                showAlert("Request jama ho gayi hai. Amount wallet mein add kar diya gaya hai.");
            } catch (error) {
                showAlert(`Request fail ho gayi: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false; submitBtn.innerHTML = 'Request Jama Karein';
            }
        }

        function openWithdrawModal() {
            const winnings = userData.wallet?.winnings || 0;
            const content = `<button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button><h2 class="text-xl font-bold mb-2">Paise Nikalein</h2><p class="text-sm text-gray-400 mb-4">Aap ₹${winnings.toFixed(2)} tak nikal sakte hain. (Minimum ₹100)</p><form id="withdraw-form"><input type="number" id="withdraw-amount" placeholder="Amount" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required /><textarea id="withdraw-details" placeholder="Aapki UPI ID ya Bank Details" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required></textarea><button type="submit" class="w-full mt-4 p-3 bg-yellow-500 text-black rounded-lg font-bold">Request Withdraw</button></form>`;
            renderModal('withdraw-modal', content);
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawRequest);
        }

        async function handleWithdrawRequest(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const details = document.getElementById('withdraw-details').value;
            const winnings = userData.wallet?.winnings || 0;

            if (!amount || !details.trim()) { showAlert("Kripya sahi details daalein.", true); return; }
            if (amount < 100) { showAlert("Kam se kam ₹100 nikal sakte hain.", true); return; }
            if (amount > winnings) { showAlert("Aapke paas itne paise nahi hain.", true); return; }
            
            try {
                const { error } = await dbClient.from('withdrawals').insert({
                    user_id: currentUser.id, user_name: userData.name, gross_amount: amount, upi_id: details
                });
                if (error) throw error;
                
                closeModal();
                showAlert("Withdraw request bhej di gayi hai. 2-4 ghante mein process ho jayegi.");
            } catch (error) {
                showAlert(`Request fail ho gayi: ${error.message}`, true);
            }
        }
        
        // --- Main App Initialization ---
        function initializeMainApp() {
            if (document.getElementById('home-page').classList.contains('initialized')) return;
            document.getElementById('home-page').classList.add('active', 'initialized');
            
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.dataset.tab;
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === `${tabId}-page`));
                });
            });

            document.getElementById('header-wallet-btn').addEventListener('click', openWalletModal);
            document.getElementById('logout-btn').addEventListener('click', () => dbClient.auth.signOut());
            document.getElementById('view-battles-btn').addEventListener('click', () => document.querySelector('[data-tab="battles"]').click());
            document.getElementById('create-battle-btn').addEventListener('click', () => alert("Battle system jald hi aa raha hai!"));
        }

        function updateUIWithUserData() {
             if (!userData || !currentUser) return;
            const wallet = userData.wallet || { cash: 0, winnings: 0, bonus: 0 };
            const totalBalance = wallet.cash + wallet.winnings + wallet.bonus;
            document.getElementById('header-wallet-balance').textContent = `₹${totalBalance.toFixed(2)}`;
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-email').textContent = userData.email;
            document.getElementById('profile-cash-won').textContent = `₹${userData.total_winnings || 0}`;
            document.getElementById('profile-battles-played').textContent = userData.battles_played || 0;
            const avatarUrl = generateAvatar(currentUser.id, userData.name);
            document.getElementById('header-profile-btn').innerHTML = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full">`;
            document.getElementById('profile-page-avatar').src = avatarUrl;
        }

        // --- Auth State Change Handler ---
        dbClient.auth.onAuthStateChange(async (event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                
                const { data, error } = await dbClient.from('users').select('*').eq('id', currentUser.id).single();
                if (data) {
                    userData = data;
                    authContainer.innerHTML = '';
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    initializeMainApp();
                    updateUIWithUserData(); 
                } else {
                    // This case is handled during signup
                    console.log("User in auth but not in DB, waiting for creation...");
                }
            } else {
                currentUser = null;
                userData = null;
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
                renderAuthScreen();
            }
        });
    </script>
</body>
</html>
