<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DevilWin - Kheliye aur Jeetiye</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #1a0b2e; color: #f0f0f0; }
        .ludo-bg-pattern { background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 15px 15px; }
        .glassmorphism { background: rgba(40, 25, 65, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bottom-nav-item.active { color: #facc15; }
        #qrcode-container img { background: white; padding: 10px; border-radius: 8px; }
        .winner-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
            background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .winner-animation i { font-size: 100px; color: #facc15; animation: crown-pop 0.5s ease-out; }
        .winner-animation p { font-size: 2rem; font-weight: bold; color: white; animation: text-fade-in 1s ease-out; }
        @keyframes crown-pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes text-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        .history-item .status-pending { color: #facc15; }
        .history-item .status-approved, .history-item .status-completed { color: #4ade80; }
        .history-item .status-rejected { color: #f87171; }
        .faq-answer { display: none; }
    </style>
</head>
<body class="ludo-bg-pattern">

    <div id="global-alert" class="hidden fixed top-5 left-1/2 -translate-x-1/2 glassmorphism p-3 rounded-full shadow-lg z-[100] border-l-4 max-w-sm w-full">
        <p id="global-alert-message" class="text-center text-sm font-medium text-white"></p>
    </div>

    <div id="app-container" class="hidden">
        <header class="p-3 flex justify-between items-center bg-gray-900/50 backdrop-blur-md sticky top-0 z-20 border-b border-gray-700">
            <h1 class="text-2xl font-extrabold text-yellow-400 drop-shadow-lg">DevilWin</h1>
            <div class="flex items-center space-x-4">
                <button id="header-wallet-btn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold px-4 py-2 rounded-full shadow-lg flex items-center">
                    <i class="fas fa-wallet mr-2"></i><span id="header-wallet-balance">₹0.00</span>
                </button>
                <div class="relative">
                    <button id="header-profile-btn" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                         <i class="fas fa-user text-xl text-gray-300"></i>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-50">
                        <a href="#" id="profile-menu-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Profile</a>
                        <a href="#" id="help-support-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Help & Support</a>
                        <a href="#" id="share-refer-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Share & Refer</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="pb-20">
            <!-- Home Page -->
            <div id="home-page" class="page p-4 space-y-6">
                 <div class="bg-gradient-to-br from-red-600 to-purple-700 p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold">Ludo King Battles</h2>
                    <p class="text-purple-200 mb-4">Create or Join Rooms & Win Big!</p>
                    <button id="view-battles-btn" class="bg-white text-black font-bold px-8 py-3 rounded-full shadow-md hover:scale-105 transition-transform">View All Battles</button>
                </div>
                <!-- Leaderboard Section -->
                <div class="bg-gray-800/50 p-4 rounded-2xl">
                    <h2 class="text-xl font-bold text-center text-yellow-400 mb-4">Aaj ke Champions</h2>
                    <div id="leaderboard-bots" class="flex justify-around mb-4"></div>
                    <div id="leaderboard-real" class="space-y-2">
                        <p class="text-center text-gray-400">Loading live rankings...</p>
                    </div>
                </div>
            </div>
            <!-- Battles Page -->
            <div id="battles-page" class="page p-4 space-y-6">
                 <div class="flex justify-end">
                    <button id="create-battle-btn" class="bg-gradient-to-r from-red-500 to-yellow-500 text-white font-bold px-6 py-2 rounded-lg">Create Battle</button>
                </div>
                <!-- Live Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-satellite-dish text-red-500 mr-2 animate-pulse"></i>Live Battles</h2>
                    <div id="live-battles-list" class="space-y-3">
                        <p class="text-center text-gray-500">No live battles right now.</p>
                    </div>
                </div>
                <!-- Active Battles -->
                <div>
                    <h2 class="text-xl font-bold mb-2">Active Battles</h2>
                    <div id="active-battles-list" class="space-y-3">
                        <!-- Content will be rendered by JS -->
                    </div>
                </div>
            </div>
            <!-- Profile Page -->
            <div id="profile-page" class="page p-4">
                 <div class="bg-gray-800 rounded-lg p-6 flex flex-col items-center">
                    <div id="profile-page-avatar" class="w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center mb-4"><i class="fas fa-user text-5xl text-gray-500"></i></div>
                    <div class="flex items-center">
                        <h2 id="profile-name" class="text-2xl font-bold"></h2>
                        <button id="edit-name-btn" class="ml-3 text-gray-400 hover:text-white"><i class="fas fa-pencil-alt"></i></button>
                    </div>
                    <p id="profile-email" class="text-gray-400"></p>
                    <p id="profile-uid" class="text-xs text-gray-500 mt-2 bg-gray-900 px-2 py-1 rounded-full"></p>
                </div>

                 <div class="bg-gray-800 p-6 rounded-2xl space-y-4 mt-6">
                    <h3 class="font-bold text-lg">Refer & Earn</h3>
                    <p class="text-gray-400">Your Referral Code</p>
                    <div class="my-2 p-3 bg-gray-900 border-2 border-dashed border-yellow-400 rounded-lg flex justify-between items-center">
                        <p id="referral-code-display" class="text-2xl font-bold tracking-widest text-yellow-400"></p>
                        <button id="copy-referral-btn"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-md border-t border-gray-700 flex justify-around">
            <button data-tab="home" class="bottom-nav-item active flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-home text-xl mb-1"></i><span class="font-bold">Home</span></button>
            <button data-tab="battles" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-swords text-xl mb-1"></i><span class="font-bold">Battles</span></button>
            <button data-tab="profile-nav" class="bottom-nav-item flex-1 p-2 flex flex-col items-center text-xs text-gray-400"><i class="fas fa-user text-xl mb-1"></i><span class="font-bold">Profile</span></button>
        </nav>
    </div>

    <div id="auth-container">
        <!-- This will be replaced by the loading indicator or the login form -->
    </div>
    <div id="modals-container"></div>
    <div id="winner-animation-container"></div>

    <script type="module">
        // --- Supabase Client Setup ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://pcnrpyjxhaxhdgxqiker.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjbnJweWp4aGF4aGRneHFpa2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNjAyNzEsImV4cCI6MjA2NzczNjI3MX0.OyR6dfZs2lADfhuG4Dki9b9zBUMOQ1LorbfQmmCXAW4';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // --- Global State & Constants ---
        let currentUser = null;
        let userData = null;
        let battlesSubscription = null;
        
        // --- UI Elements ---
        const appContainer = document.getElementById('app-container');
        const authContainer = document.getElementById('auth-container');
        const modalsContainer = document.getElementById('modals-container');
        
        // --- Helper Functions ---
        const generateAvatar = (seed = 'default', name = 'user') => {
            const femaleNames = ['priya', 'seema', 'pooja', 'sunita', 'geeta', 'neha', 'riya', 'sonia', 'mona', 'asha', 'rani', 'anita', 'kavita'];
            const firstName = name ? name.split(' ')[0].toLowerCase() : 'user';
            const gender = femaleNames.includes(firstName) ? 'female' : 'male';
            return `https://api.dicebear.com/8.x/personas/svg?seed=${seed}&sex=${gender}`;
        };

        function showAlert(message, isError = false) {
            const alertBox = document.getElementById('global-alert');
            alertBox.classList.remove('hidden', 'border-green-500', 'border-red-500');
            alertBox.classList.add(isError ? 'border-red-500' : 'border-green-500');
            document.getElementById('global-alert-message').textContent = message;
            setTimeout(() => alertBox.classList.add('hidden'), 5000);
        }

        const renderModal = (id, content) => {
            closeModal();
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = "modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4";
            modal.innerHTML = `<div class="modal-content glassmorphism rounded-2xl w-full max-w-sm p-6 relative">${content}</div>`;
            modalsContainer.appendChild(modal);
            modal.addEventListener('click', (e) => { 
                if (e.target.id === id) {
                    closeModal();
                }
            });
        };

        const closeModal = () => { modalsContainer.innerHTML = ''; };
        
        window.closeModal = closeModal;

        // --- Authentication ---
        const renderAuthScreen = () => {
             authContainer.innerHTML = `
                <div class="p-6 flex flex-col justify-center min-h-screen">
                    <h1 class="text-5xl font-extrabold text-center mb-2 text-yellow-400 drop-shadow-lg">DevilWin</h1>
                    <p class="text-center text-gray-300 mb-8" id="auth-subtitle">Login to Your Kingdom</p>
                    
                    <button id="google-login-btn" class="w-full p-3 mb-4 bg-white text-gray-700 rounded-lg font-bold flex items-center justify-center shadow-md hover:bg-gray-200 transition-colors">
                        <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-6 h-6 mr-3">
                        Sign in with Google
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="flex-shrink mx-4 text-gray-400">OR</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>

                    <p id="auth-error" class="bg-red-500/20 text-red-300 p-3 rounded-lg mb-4 text-center hidden"></p>
                    <form id="auth-form" class="space-y-4">
                        <div id="name-field" class="hidden"><input type="text" placeholder="Aapka Poora Naam" id="auth-name" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" /></div>
                        <input type="text" placeholder="Email ya Phone Number" id="auth-email" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" required />
                        <input type="password" placeholder="6 digit password enter" id="auth-password" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" required />
                        <div id="referral-field" class="hidden"><input type="text" placeholder="Referral Code (Optional)" id="auth-referral" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" /></div>
                        <button type="submit" id="auth-submit-btn" class="w-full p-3 bg-gradient-to-r from-red-500 to-yellow-500 rounded-lg font-bold text-white hover:opacity-90 transition-opacity disabled:opacity-50">Login</button>
                    </form>
                    <p class="text-center mt-6 text-gray-400">
                        <span id="auth-toggle-text">Naye khiladi hain?</span>
                        <button id="auth-toggle-btn" class="text-yellow-400 font-bold ml-2 hover:underline">Sign Up</button>
                    </p>
                </div>
            `;
            attachAuthListeners();
        };
        function attachAuthListeners() {
            let isLogin = true;
            const form = document.getElementById('auth-form');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            const googleLoginBtn = document.getElementById('google-login-btn');

            googleLoginBtn.addEventListener('click', async () => {
                await supabase.auth.signInWithOAuth({
                    provider: 'google',
                });
            });
            
            toggleBtn.addEventListener('click', () => {
                isLogin = !isLogin;
                document.getElementById('name-field').classList.toggle('hidden', isLogin);
                document.getElementById('referral-field').classList.toggle('hidden', isLogin);
                document.getElementById('auth-subtitle').textContent = isLogin ? 'Apne Kingdom mein Login karein' : 'Ultimate Battle Join Karein';
                document.getElementById('auth-toggle-text').textContent = isLogin ? "Naye khiladi hain?" : "Pehle se champion hain?";
                toggleBtn.textContent = isLogin ? "Sign Up" : "Login";
                document.getElementById('auth-submit-btn').textContent = isLogin ? "Login" : "Account Banayein";
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                let email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const name = document.getElementById('auth-name').value;
                const referralCode = document.getElementById('auth-referral').value;
                const errorEl = document.getElementById('auth-error');
                const submitBtn = document.getElementById('auth-submit-btn');
                
                if (!email.includes('@') && /^\d{10}$/.test(email)) {
                    email = `${email}@devilwin.com`;
                }

                submitBtn.disabled = true;
                errorEl.classList.add('hidden');

                try {
                    let response;
                    if (isLogin) {
                        response = await supabase.auth.signInWithPassword({ email, password });
                    } else {
                        if (!name.trim()) {
                           throw new Error("Kripya apna naam darj karein.");
                        }
                        response = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: {
                                data: { 
                                    name: name.trim(),
                                    referral_code_used: referralCode
                                }
                            }
                        });
                    }

                    if (response.error) {
                        throw response.error;
                    }

                } catch (err) {
                    console.error("Supabase Auth Error:", err);
                    errorEl.textContent = err.message || 'Login/Signup fail ho gaya. Kripya baad mein try karein.';
                    errorEl.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                }
            });
        }
        
        // --- Wallet & Transactions ---
        function openWalletModal() {
            if (!userData) return;
            const totalBalance = (userData.main_balance || 0) + (userData.bonus_balance || 0);
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Mera Wallet</h2>
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-xl mb-4">
                    <p class="text-sm text-gray-200">Total Balance</p>
                    <p class="text-3xl font-bold">₹${totalBalance.toFixed(2)}</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center text-sm mb-4">
                    <div class="bg-gray-700 p-2 rounded-lg"><p class="text-gray-400">Main Balance</p><p class="font-bold">₹${(userData.main_balance || 0).toFixed(2)}</p></div>
                    <div class="bg-gray-700 p-2 rounded-lg"><p class="text-gray-400">Bonus</p><p class="font-bold">₹${(userData.bonus_balance || 0).toFixed(2)}</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-deposit-modal" class="bg-green-600 p-3 rounded-lg font-bold">Paise Daalein</button>
                    <button id="open-withdraw-modal" class="bg-yellow-500 text-black p-3 rounded-lg font-bold">Paise Nikalein</button>
                </div>
                <div class="mt-4">
                    <button id="open-history-modal" class="w-full bg-gray-600 p-3 rounded-lg font-bold">Transaction History</button>
                </div>
            `;
            renderModal('wallet-modal', content);
        }
        
        // --- Battle System ---
        function openCreateBattleModal() {
            const content = `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4">Naya Battle Banayein</h2>
                <form id="create-battle-form">
                    <input type="number" id="battle-amount" placeholder="Amount (e.g., 50)" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 mb-3" required />
                    <button type="submit" class="w-full mt-4 p-3 bg-green-600 rounded-lg font-bold">Battle Banayein</button>
                </form>
            `;
            renderModal('create-battle-modal', content);
            document.getElementById('create-battle-form').addEventListener('submit', handleCreateBattle);
        }

        async function handleCreateBattle(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('battle-amount').value);
            if (!amount || amount <= 0) {
                showAlert("Sahi amount daalein.", true); return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = 'Creating...';

            try {
                const { data, error } = await supabase.rpc('create_battle', { p_amount: amount });

                if (error) {
                    throw error;
                }
                
                closeModal();
                showAlert("Aapka battle ban gaya hai!");
            } catch (error) {
                console.error("Battle creation failed:", error);
                showAlert(`Battle banane mein dikkat aayi: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Battle Banayein';
            }
        }

        function renderBattles(battles) {
            const activeList = document.getElementById('active-battles-list');
            const liveList = document.getElementById('live-battles-list');
            activeList.innerHTML = '';
            liveList.innerHTML = '';
            let activeCount = 0, liveCount = 0;

            for (const battle of battles) {
                const battleCard = document.createElement('div');
                battleCard.className = 'glassmorphism p-4 rounded-lg flex justify-between items-center';
                const isCreator = battle.creator_id === currentUser.id;

                if (battle.status === 'active') {
                    activeCount++;
                    battleCard.innerHTML = `
                        <div>
                            <p class="font-bold">${battle.profiles?.name || 'Player'}</p>
                            <p class="text-sm text-yellow-400">Amount: ₹${battle.amount}</p>
                        </div>
                        ${isCreator ? 
                            `<button class="creator-cancel-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" data-id="${battle.id}" data-amount="${battle.amount}">Cancel</button>` :
                            `<button class="request-join-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded" data-id="${battle.id}">Request</button>`
                        }
                    `;
                    activeList.appendChild(battleCard);
                }
                // TODO: Add rendering for other battle statuses (live, requested, etc.)
            }

            if (activeCount === 0) activeList.innerHTML = '<p class="text-center text-gray-500">No active battles. Create one!</p>';
            if (liveCount === 0) liveList.innerHTML = '<p class="text-center text-gray-500">No live battles right now.</p>';
        }

        async function listenToBattles() {
            if (battlesSubscription) {
                battlesSubscription.unsubscribe();
            }

            // Initial fetch
            const { data: initialBattles, error } = await supabase
                .from('battles')
                .select(`*, profiles (name)`) // Fetch creator's name
                .in('status', ['active', 'requested', 'live', 'disputed']);
            
            if (error) {
                console.error("Error fetching initial battles:", error);
                return;
            }
            renderBattles(initialBattles);

            // Listen for realtime changes
            battlesSubscription = supabase
                .channel('public:battles')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'battles' }, async (payload) => {
                    console.log('Battle change received!', payload);
                    // Refetch all battles to update the UI
                     const { data: updatedBattles, error: updateError } = await supabase
                        .from('battles')
                        .select(`*, profiles (name)`)
                        .in('status', ['active', 'requested', 'live', 'disputed']);
                    if (updateError) {
                        console.error("Error fetching updated battles:", updateError);
                    } else {
                        renderBattles(updatedBattles);
                    }
                })
                .subscribe();
        }

        // --- Main App Initialization ---
        function initializeMainApp() {
            if (document.getElementById('home-page').classList.contains('initialized')) return;
            
            if (!currentUser) return;

            document.getElementById('home-page').classList.add('active', 'initialized');
            
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.dataset.tab;
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    if(tabId === 'profile-nav') {
                         document.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === 'profile-page'));
                    } else {
                         document.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === `${tabId}-page`));
                    }
                });
            });

            const profileBtn = document.getElementById('header-profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');
            profileBtn.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
            
            document.getElementById('header-wallet-btn').addEventListener('click', openWalletModal);
            document.getElementById('profile-menu-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('[data-tab="profile-nav"]').click();
                profileDropdown.classList.add('hidden');
            });
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await supabase.auth.signOut();
            });
            document.getElementById('view-battles-btn').addEventListener('click', () => document.querySelector('[data-tab="battles"]').click());
            document.getElementById('create-battle-btn').addEventListener('click', openCreateBattleModal);
            document.getElementById('copy-referral-btn').addEventListener('click', () => {
                if(navigator.clipboard && userData?.referral_code) {
                    navigator.clipboard.writeText(userData.referral_code);
                    showAlert('Referral code copy ho gaya!');
                }
            });

            updateUIWithUserData();
            listenToBattles();
        }

        function updateUIWithUserData() {
             if (!userData || !currentUser) return;
            const totalBalance = (userData.main_balance || 0) + (userData.bonus_balance || 0);
            document.getElementById('header-wallet-balance').textContent = `₹${totalBalance.toFixed(2)}`;
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-email').textContent = userData.email.includes('@devilwin.com') ? userData.email.split('@')[0] : userData.email;
            
            const referralCodeDisplay = document.getElementById('referral-code-display');
            if (referralCodeDisplay) {
                referralCodeDisplay.textContent = userData.referral_code;
            }
            
            const profileUid = document.getElementById('profile-uid');
            if (profileUid) {
                profileUid.textContent = `ID: ${currentUser.id}`;
            }

            const avatarUrl = generateAvatar(currentUser.id, userData.name);
            document.getElementById('header-profile-btn').innerHTML = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full">`;
            
            const profilePageAvatar = document.getElementById('profile-page-avatar');
            if (profilePageAvatar) {
                profilePageAvatar.innerHTML = `<img src="${avatarUrl}" class="w-24 h-24 rounded-full">`;
            }
        }

        // --- Auth State Change Handler ---
        const showLoadingScreen = () => {
            authContainer.innerHTML = `
                <div class="flex min-h-screen items-center justify-center">
                    <div>
                        <h1 class="text-5xl font-extrabold text-center mb-2 text-yellow-400 drop-shadow-lg">DevilWin</h1>
                        <p class="text-center text-gray-300 mt-4 text-xl animate-pulse">Loading...</p>
                    </div>
                </div>
            `;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        };

        const showApp = () => {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeMainApp();
        };

        const showLogin = () => {
            appContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
            renderAuthScreen();
        };

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingScreen();

            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event);
                try {
                    const user = session?.user;

                    if (battlesSubscription) {
                        battlesSubscription.unsubscribe();
                        battlesSubscription = null;
                    }

                    if (user) {
                        console.log('User found, fetching profile...');
                        currentUser = user;
                        
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', user.id)
                            .single();

                        if (error && error.code !== 'PGRST116') { // Ignore "No rows found" error
                            throw new Error(`Error fetching profile: ${error.message}`);
                        }
                        
                        if (data) {
                            console.log('Profile found, showing app.');
                            userData = data;
                            showApp();
                        } else {
                            // This can happen if the user is created in auth but the profile trigger fails.
                            // We log them out to force a clean state.
                            throw new Error("User profile not found. Logging out.");
                        }

                    } else {
                        console.log('No user session found, showing login screen.');
                        currentUser = null;
                        userData = null;
                        showLogin();
                    }
                } catch (e) {
                    console.error("Critical error in auth state handler:", e);
                    showAlert(`An error occurred: ${e.message}. Please refresh.`, true);
                    showLogin(); // Fallback to login screen on any error
                }
            });
        });
    </script>
</body>
</html>
